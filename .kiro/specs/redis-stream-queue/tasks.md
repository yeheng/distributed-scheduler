# Redis Stream消息队列实现任务规划

## 实施计划

- [x] 1. 扩展配置模型支持Redis Stream
  - 在MessageQueueConfig中添加Redis配置支持
  - 添加MessageQueueType枚举
  - 实现配置验证逻辑
  - _需求: 3.1, 3.2, 3.3_

- [x] 2. 创建Redis Stream消息队列基础结构
  - 创建新的crate或模块结构
  - 添加redis-rs依赖到Cargo.toml
  - 创建RedisStreamMessageQueue结构体
  - 实现基本的构造函数
  - _需求: 1.1, 1.6_

- [x] 3. 实现配置集成
  - 创建RedisConfig结构体
  - 实现从AppConfig解析Redis配置
  - 添加配置验证逻辑
  - _需求: 3.1, 3.2, 3.3_

- [x] 4. 实现MessageQueue trait - 消息发布
  - 实现publish_message方法
  - 添加消息序列化逻辑
  - 实现Stream创建逻辑
  - 添加错误处理和重试机制
  - _需求: 1.1, 1.2, 1.4, 1.5_

- [x] 5. 实现MessageQueue trait - 消息消费
  - 实现consume_messages方法
  - 创建消费者组管理逻辑
  - 实现消息反序列化
  - 添加消费者组自动创建
  - _需求: 1.1, 1.3, 1.7_

- [x] 6. 实现MessageQueue trait - 消息确认
  - 实现ack_message方法
  - 实现nack_message方法
  - 添加重新入队逻辑
  - _需求: 1.8, 2.1_

- [x] 7. 实现MessageQueue trait - 队列管理
  - 实现create_queue方法
  - 实现delete_queue方法
  - 实现get_queue_size方法
  - 实现purge_queue方法
  - _需求: 1.1, 1.5_

- [x] 8. 创建集成测试
  - 创建Redis Stream集成测试
  - 添加并发测试用例
  - 实现故障恢复测试
  - 验证与RabbitMQ实现的等价性
  - _需求: 2.2, 4.1, 4.2, 4.3, 4.4_

- [x] 9. 创建配置切换机制
  - 实现基于配置的消息队列工厂
  - 添加运行时切换支持
  - 创建配置示例文件
  - _需求: 2.1, 2.3_

- [ ] 10. 性能优化和清理
  - 优化连接池配置
  - 添加性能监控指标
  - 代码重构和文档完善
  - 最终集成测试
  - _需求: 4.1, 4.2, 4.3, 4.4_

## 任务详情

### 任务1：扩展配置模型支持Redis Stream

**目标**: 扩展现有的配置系统以支持Redis Stream消息队列

**具体步骤**:
1. 在`crates/core/src/config/model.rs`中添加RedisConfig结构体
2. 扩展MessageQueueConfig添加type字段和redis配置
3. 更新配置验证逻辑
4. 创建配置示例文件

**验证标准**:
- 配置文件可以正确解析Redis配置
- 配置验证通过
- 保持向后兼容性

### 任务2：创建Redis Stream消息队列基础结构

**目标**: 创建RedisStreamMessageQueue的基础实现框架

**具体步骤**:
1. 在`crates/infrastructure/src/`下创建`redis_stream`模块
2. 添加redis = "0.23"依赖到infrastructure Cargo.toml
3. 创建RedisStreamMessageQueue结构体
4. 实现new()构造函数
5. 添加连接管理逻辑

**验证标准**:
- 结构体编译通过
- 可以创建Redis连接
- 遵循现有代码风格

### 任务3：实现配置集成

**目标**: 将Redis配置集成到现有配置系统

**具体步骤**:
1. 扩展AppConfig以支持Redis配置
2. 实现配置工厂模式
3. 添加配置验证
4. 创建配置文档

**验证标准**:
- 配置可以正确加载
- 验证逻辑工作正常
- 文档清晰完整

### 任务4：实现MessageQueue trait - 消息发布

**目标**: 实现消息的发布功能

**具体步骤**:
1. 实现publish_message方法
2. 添加消息序列化（使用serde_json）
3. 实现Stream自动创建
4. 添加错误重试机制
5. 实现连接池管理

**验证标准**:
- 消息可以成功发布
- Stream自动创建
- 错误处理正确
- 重试机制工作

### 任务5：实现MessageQueue trait - 消息消费

**目标**: 实现消息的消费功能

**具体步骤**:
1. 实现consume_messages方法
2. 创建消费者组管理
3. 实现消息反序列化
4. 添加消费者组自动创建
5. 实现消息重试逻辑

**验证标准**:
- 消息可以成功消费
- 消费者组自动创建
- 消息反序列化正确
- 处理失败重试

### 任务6：实现MessageQueue trait - 消息确认

**目标**: 实现消息确认和拒绝机制

**具体步骤**:
1. 实现ack_message方法（使用XACK）
2. 实现nack_message方法（使用XDEL和重新发布）
3. 添加重新入队逻辑
4. 实现幂等性保证

**验证标准**:
- 消息确认正确
- 消息拒绝和重新入队工作
- 幂等性保证

### 任务7：实现MessageQueue trait - 队列管理

**目标**: 实现队列管理功能

**具体步骤**:
1. 实现create_queue（创建Stream和消费者组）
2. 实现delete_queue（删除Stream）
3. 实现get_queue_size（使用XLEN）
4. 实现purge_queue（使用XTRIM）

**验证标准**:
- 所有队列管理功能工作
- 边界条件处理正确
- 错误处理完整

### 任务8：创建集成测试

**目标**: 创建完整的集成测试套件

**具体步骤**:
1. 创建Redis容器测试环境
2. 编写基础功能测试
3. 添加并发测试
4. 实现故障恢复测试
5. 创建性能基准测试

**验证标准**:
- 所有测试通过
- 覆盖主要使用场景
- 性能测试有基准

### 任务9：创建配置切换机制

**目标**: 实现基于配置的消息队列切换

**具体步骤**:
1. 创建消息队列工厂
2. 实现运行时选择逻辑
3. 更新配置示例
4. 创建迁移文档

**验证标准**:
- 可以通过配置切换实现
- 不需要修改业务代码
- 配置清晰易懂

### 任务10：性能优化和清理

**目标**: 最终优化和清理

**具体步骤**:
1. 优化连接池配置
2. 添加性能监控
3. 代码重构
4. 文档完善
5. 最终集成测试

**验证标准**:
- 性能满足要求
- 代码质量高
- 文档完整
- 测试全部通过

## 开发顺序说明

任务按依赖关系排序，建议按顺序执行：
1. 先完成配置和基础结构（任务1-3）
2. 然后实现核心功能（任务4-7）
3. 接着创建测试（任务8）
4. 最后实现配置切换和优化（任务9-10）

每个任务都是独立的编码单元，可以单独测试和验证。