# ç³»ç»Ÿæ¶æ„

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼ŒåŸºäºRustæ„å»ºï¼Œæ”¯æŒé«˜å¹¶å‘ä»»åŠ¡è°ƒåº¦å’Œåˆ†å¸ƒå¼Workerç®¡ç†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   API æœåŠ¡   â”‚    â”‚   è°ƒåº¦å™¨     â”‚    â”‚   Worker    â”‚   â”‚
â”‚  â”‚   (REST)    â”‚    â”‚(Dispatcher) â”‚    â”‚   (æ‰§è¡Œå™¨)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)                â”‚   â”‚
â”‚  â”‚         RabbitMQ / Redis Stream                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   æ•°æ®åº“     â”‚    â”‚    ç¼“å­˜      â”‚    â”‚    ç›‘æ§      â”‚   â”‚
â”‚  â”‚(PostgreSQL) â”‚    â”‚   (Redis)   â”‚    â”‚(Prometheus) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ¨¡å—æ¶æ„

### Crateä¾èµ–å±‚æ¬¡

```
scheduler (ä¸»ç¨‹åº)
â”œâ”€â”€ api/           # HTTP APIæœåŠ¡
â”œâ”€â”€ dispatcher/    # ä»»åŠ¡è°ƒåº¦å™¨
â”œâ”€â”€ worker/        # ä»»åŠ¡æ‰§è¡Œå™¨
â”œâ”€â”€ application/   # ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€ infrastructure/# åŸºç¡€è®¾æ–½å±‚
â”œâ”€â”€ domain/        # é¢†åŸŸæ¨¡å‹
â”œâ”€â”€ config/        # é…ç½®ç®¡ç†
â”œâ”€â”€ observability/ # ç›‘æ§æ—¥å¿—
â””â”€â”€ errors/        # é”™è¯¯å¤„ç†
```

### æ ¸å¿ƒç»„ä»¶èŒè´£

#### APIæœåŠ¡ (api/)
- HTTP RESTæ¥å£
- è¯·æ±‚éªŒè¯å’Œè·¯ç”±
- è®¤è¯æˆæƒä¸­é—´ä»¶
- APIæ–‡æ¡£ç”Ÿæˆ

#### è°ƒåº¦å™¨ (dispatcher/)  
- ä»»åŠ¡è°ƒåº¦ç­–ç•¥
- ä¾èµ–ç®¡ç†
- æ•…éšœæ£€æµ‹å’Œæ¢å¤
- Workerè´Ÿè½½å‡è¡¡

#### Worker (worker/)
- ä»»åŠ¡æ‰§è¡Œå¼•æ“
- å¿ƒè·³ç®¡ç†
- çŠ¶æ€ä¸ŠæŠ¥
- æ”¯æŒå¤šç§æ‰§è¡Œå™¨ç±»å‹

#### åŸºç¡€è®¾æ–½ (infrastructure/)
- æ•°æ®åº“è®¿é—®å±‚
- æ¶ˆæ¯é˜Ÿåˆ—é€‚é…å™¨
- ç¼“å­˜ç®¡ç†
- å¤–éƒ¨æœåŠ¡é›†æˆ

## ğŸ”„ æ•°æ®æµ

### ä»»åŠ¡åˆ›å»ºæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ APIæœåŠ¡ â†’ éªŒè¯å‚æ•° â†’ å­˜å‚¨ä»»åŠ¡ â†’ å‘é€è°ƒåº¦æ¶ˆæ¯ â†’ è°ƒåº¦å™¨æ¥æ”¶
```

### ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
è°ƒåº¦å™¨ â†’ é€‰æ‹©Worker â†’ å‘é€ä»»åŠ¡æ¶ˆæ¯ â†’ Workeræ‰§è¡Œ â†’ ç»“æœä¸ŠæŠ¥ â†’ çŠ¶æ€æ›´æ–°
```

### çŠ¶æ€åŒæ­¥æµç¨‹

```
Workerå¿ƒè·³ â†’ è°ƒåº¦å™¨æ›´æ–°çŠ¶æ€ â†’ APIæŸ¥è¯¢æœ€æ–°çŠ¶æ€ â†’ è¿”å›ç»™ç”¨æˆ·
```

## ğŸ—ƒï¸ æ•°æ®æ¨¡å‹

### æ ¸å¿ƒå®ä½“

#### ä»»åŠ¡ (Task)
```rust
pub struct Task {
    pub id: Option<i64>,
    pub name: String,           // ä»»åŠ¡åç§°
    pub executor: String,       // æ‰§è¡Œå™¨ç±»å‹ (shell, http, etc)
    pub command: Option<String>, // Shellå‘½ä»¤
    pub schedule: Option<String>, // Cronè¡¨è¾¾å¼
    pub status: TaskStatus,     // ä»»åŠ¡çŠ¶æ€
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

#### ä»»åŠ¡è¿è¡Œ (TaskRun)  
```rust
pub struct TaskRun {
    pub id: Option<i64>,
    pub task_id: i64,
    pub worker_id: Option<String>,
    pub status: TaskRunStatus,  // è¿è¡ŒçŠ¶æ€
    pub started_at: Option<DateTime<Utc>>,
    pub completed_at: Option<DateTime<Utc>>,
    pub result: Option<String>, // æ‰§è¡Œç»“æœ
    pub error: Option<String>,  // é”™è¯¯ä¿¡æ¯
}
```

#### Workerä¿¡æ¯ (WorkerInfo)
```rust
pub struct WorkerInfo {
    pub id: String,            // Workerå”¯ä¸€æ ‡è¯†
    pub name: String,          // Workeråç§°
    pub status: WorkerStatus,  // çŠ¶æ€ (Online, Offline, Busy)
    pub last_heartbeat: DateTime<Utc>,
    pub current_tasks: i32,    // å½“å‰æ‰§è¡Œä»»åŠ¡æ•°
    pub max_tasks: i32,        // æœ€å¤§ä»»åŠ¡å®¹é‡
}
```

## ğŸ”§ å…³é”®æŠ€æœ¯å†³ç­–

### æ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©
- **RabbitMQ**: å¯é æ¶ˆæ¯ä¼ é€’ï¼Œæ”¯æŒå¤æ‚è·¯ç”±
- **Redis Stream**: é«˜æ€§èƒ½ï¼Œç®€å•éƒ¨ç½²
- æ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢ï¼Œé€šè¿‡é…ç½®ç®¡ç†

### æ•°æ®åº“é€‰æ‹©
- **PostgreSQL**: ç”Ÿäº§ç¯å¢ƒæ¨èï¼Œæ”¯æŒäº‹åŠ¡
- **SQLite**: å¼€å‘ç¯å¢ƒï¼Œç®€å•éƒ¨ç½²
- ä½¿ç”¨SQLxå®ç°ç±»å‹å®‰å…¨çš„SQLæ“ä½œ

### å¹¶å‘æ¨¡å‹
- åŸºäºTokioå¼‚æ­¥è¿è¡Œæ—¶
- æ— é”æ•°æ®ç»“æ„å‡å°‘ç«äº‰
- èƒŒå‹æ§åˆ¶é˜²æ­¢è¿‡è½½

### å®¹é”™æœºåˆ¶
- ç†”æ–­å™¨æ¨¡å¼é˜²æ­¢çº§è”æ•…éšœ
- æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- æ•…éšœè½¬ç§»å’Œè‡ªåŠ¨æ¢å¤

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### è°ƒåº¦æ€§èƒ½
- **ååé‡**: 10,000+ tasks/minute
- **å»¶è¿Ÿ**: < 100ms (P99)
- **å¹¶å‘**: 1,000+ concurrent tasks

### æ‰©å±•æ€§
- **WorkerèŠ‚ç‚¹**: 100+ nodes
- **æ°´å¹³æ‰©å±•**: æ”¯æŒå¤šè°ƒåº¦å™¨å®ä¾‹
- **æ•°æ®åˆ†ç‰‡**: æ”¯æŒæ•°æ®åº“åˆ†ç‰‡

### èµ„æºä½¿ç”¨
- **å†…å­˜**: åŸºçº¿ < 50MB per service
- **CPU**: å¤šæ ¸å¹¶è¡Œå¤„ç†
- **ç½‘ç»œ**: é«˜æ•ˆäºŒè¿›åˆ¶åè®®

## ğŸ” å®‰å…¨è®¾è®¡

### è®¤è¯æˆæƒ
- APIå¯†é’¥è®¤è¯
- JWTä»¤ç‰Œæ”¯æŒ
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)

### æ•°æ®å®‰å…¨
- æ•æ„Ÿé…ç½®åŠ å¯†å­˜å‚¨
- ä¼ è¾“å±‚TLSåŠ å¯†
- SQLæ³¨å…¥é˜²æŠ¤

### ç½‘ç»œå®‰å…¨
- é˜²ç«å¢™é…ç½®å»ºè®®
- ç½‘ç»œéš”ç¦»
- å®¡è®¡æ—¥å¿—

## ğŸ” ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### æŒ‡æ ‡æ”¶é›†
- ç³»ç»ŸæŒ‡æ ‡: CPUã€å†…å­˜ã€ç½‘ç»œ
- ä¸šåŠ¡æŒ‡æ ‡: ä»»åŠ¡æˆåŠŸç‡ã€æ‰§è¡Œæ—¶é—´
- è‡ªå®šä¹‰æŒ‡æ ‡: Prometheusæ ¼å¼

### æ—¥å¿—ç³»ç»Ÿ
- ç»“æ„åŒ–æ—¥å¿— (JSONæ ¼å¼)
- åˆ†çº§æ—¥å¿—è®°å½•
- æ—¥å¿—èšåˆå’Œæœç´¢

### åˆ†å¸ƒå¼è¿½è¸ª
- OpenTelemetryé›†æˆ
- è·¨æœåŠ¡è¯·æ±‚è¿½è¸ª
- æ€§èƒ½ç“¶é¢ˆåˆ†æ

## ğŸš€ éƒ¨ç½²æ¶æ„

### å¼€å‘ç¯å¢ƒ
```
å•æœºéƒ¨ç½² + Docker Compose
- æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨åŒä¸€ä¸»æœº
- é€‚åˆå¼€å‘å’Œæµ‹è¯•
```

### ç”Ÿäº§ç¯å¢ƒ
```
åˆ†å¸ƒå¼éƒ¨ç½² + Kubernetes
- æœåŠ¡ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»
- æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½
```

### æ··åˆäº‘éƒ¨ç½²
```
å¤šäº‘ç¯å¢ƒæ”¯æŒ
- è·¨åŒºåŸŸç¾å¤‡
- æ•°æ®åŒæ­¥æœºåˆ¶
- ç½‘ç»œè¿é€šæ€§ç®¡ç†
```

